pipeline{
 agent {
   docker{
     image 'maven:3-alpine'
     args '-v /root/.m2:/root/.m2'
   }
 }
 stages {
   stage('build'){
      steps{
	     sh 'mvn -B -DskipTests clean package'
      }
   }
   stage('checkstyle'){
      steps{
         sh 'mvn checkstyle:checkstyle'
      }
   }
   stage('test'){
      steps{
        sh 'mvn test'
      }
      post{
         always{
              junit 'target/surefire-reports/*.xml'
         }
      }
   }
   stage('deployment'){
      steps{
        sh 'mvn jar:jar install:install help:evaluate -Dexpression=project.name'
      }
   }
   stage('deliver'){
      steps{
        PROJECT_NAME=sh(
          script: 'mvn help:evaluate -Dexpression=project.name | grep "^[^\[]"'
          returnStdout: true
        ).trim()
        PROJECT_VERSION=sh(
                  script: 'mvn help:evaluate -Dexpression=project.version | grep "^[^\[]"'
                  returnStdout: true
        ).trim()

        sh 'java -jar target/${PROJECT_NAME}-${PROJECT_VERSION}.jar'
      }
   }
 }
}
